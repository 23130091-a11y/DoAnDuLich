<!DOCTYPE html>
<html lang="vi">
  {% load static %}
  <head>
    <meta charset="UTF-8" />
    <title>Web Du L·ªãch</title>

    <!-- CSS th∆∞ vi·ªán -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- CSS custom -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  </head>
  <body>
    <header class="header sticky-top bg-white">
      <div class="container">
        <nav class="navbar navbar-expand-lg px-4 py-1">
          <a class="navbar-brand fw-bold" href="#">Logo</a>
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="#">Trang ch·ªß</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">L·ªãch s·ª≠</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">ƒê·ªãa ƒëi·ªÉm</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Li√™n h·ªá</a>
            </li>
          </ul>

          <button
            class="btn border-0 bg-transparent outline-0 ms-auto"
            data-bs-toggle="modal"
            data-bs-target="#authModal"
          >
            <i class="bi bi-person fs-3"></i>
          </button>
        </nav>
      </div>
    </header>

    <!-- Banner -->
    <section class="hero position-relative text-center">
      <img src="{% static 'images/banner.jpg' %}" class="hero-img" />

      <!-- Thanh t√¨m ki·∫øm 2 t·∫ßng -->
      <div
        class="search-box container-fluid rounded-4 shadow-lg p-4 border border-3 border-info position-absolute top-50 start-50 translate-middle bg-white"
      >
        <!-- üîπ √î t√¨m ki·∫øm l·ªõn ph√≠a tr√™n -->
        <div
          class="main-search mb-3 position-relative"
          style="max-width: 820px; margin: 0 auto"
        >
          <div class="input-group input-group-lg">
            <span class="input-group-text bg-white border-end-0">
              <i class="fa-solid fa-magnifying-glass text-secondary"></i>
            </span>
            <input
              type="text"
              id="searchInput"
              class="form-control border-start-0"
              placeholder="T√¨m ki·∫øm ƒë·ªãa ƒëi·ªÉm..."
              autocomplete="off"
            />
          </div>
          <div id="suggestions" class="suggestions-box"></div>
        </div>

        <!-- üîπ H√†ng nh·ªè b√™n d∆∞·ªõi: v·ªã tr√≠ - n∆°i ƒë·∫øn - ng√†y ƒëi - n√∫t -->
        <form class="row align-items-center gx-3 justify-content-center">
          <div class="col-md-3">
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="fa-solid fa-location-dot text-primary"></i>
              </span>
              <input
                type="text"
                class="form-control"
                placeholder="V·ªã tr√≠ c·ªßa b·∫°n"
              />
            </div>
          </div>

          <div class="col-md-3">
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="fa-solid fa-map-location-dot text-primary"></i>
              </span>
              <input
                type="text"
                class="form-control"
                placeholder="N∆°i b·∫°n mu·ªën ƒë·∫øn"
              />
            </div>
          </div>

          <div class="col-md-3">
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="fa-solid fa-calendar-days text-primary"></i>
              </span>
              <input type="date" class="form-control" />
            </div>
          </div>

          <div class="col-md-2">
            <button class="btn btn-warning w-100 fw-bold py-2">T√¨m ki·∫øm</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Danh m·ª•c du l·ªãch -->
    <section class="categories bg-light py-4">
      <div class="container text-center">
        <div class="row g-4">
          <div class="col">
            <i class="fa-solid fa-umbrella-beach fa-2x text-info"></i>
            <p>Du l·ªãch v√† bi·ªÉn ƒë·∫£o</p>
          </div>
          <div class="col">
            <i class="fa-solid fa-mountain fa-2x text-info"></i>
            <p>Du l·ªãch n√∫i & cao nguy√™n</p>
          </div>
          <div class="col">
            <i class="fa-solid fa-landmark fa-2x text-info"></i>
            <p>VƒÉn h√≥a - l·ªãch s·ª≠</p>
          </div>
          <div class="col">
            <i class="fa-solid fa-leaf fa-2x text-info"></i>
            <p>Du l·ªãch sinh th√°i</p>
          </div>
          <div class="col">
            <i class="fa-solid fa-utensils fa-2x text-info"></i>
            <p>·∫®m th·ª±c - ch·ª£ ƒë√™m</p>
          </div>
          <div class="col">
            <i class="fa-solid fa-gift fa-2x text-info"></i>
            <p>L·ªÖ h·ªôi - s·ª± ki·ªán</p>
          </div>
          <div class="col">
            <i class="fa-solid fa-hotel fa-2x text-info"></i>
            <p>Ngh·ªâ d∆∞·ª°ng - th∆∞ gi√£n</p>
          </div>
        </div>
      </div>
    </section>

    <!-- G·ª£i √Ω ƒë·ªãa ƒëi·ªÉm -->
    <section class="recommend py-5">
      <div class="container text-center">
        <h2 class="fw-bold mb-3">D·∫£i ƒê·∫•t H√¨nh Ch·ªØ S</h2>
        <p class="text-muted mb-4">Kh√°m ph√° Vi·ªát Nam theo c√°ch ri√™ng c·ªßa b·∫°n</p>
        <div class="row justify-content-center g-4">
          {% for r in results %}
          <div class="col-md-3">
            <div class="card shadow-sm border-0 position-relative">
              <div class="image-wrapper">
                <!-- ·∫¢nh ƒë·∫ßu ti√™n -->
                <img
                  src="{% static 'images/' %}{{ r.images.0 }}"
                  class="card-img-top"
                  alt="{{ r.name }}"
                />

                <!-- Overlay slideshow -->
                <div class="image-overlay">
                  <div class="slideshow">
                    {% for img in r.images %}
                    <img
                      src="{% static 'images/' %}{{ img }}"
                      class="slide {% if forloop.first %}active{% endif %}"
                    />
                    {% endfor %}
                    <button class="prev">&#10094;</button>
                    <button class="next">&#10095;</button>
                  </div>
                </div>
              </div>

              <div class="card-body text-center">
                <h5 class="card-title fw-bold">{{ r.name }}</h5>
                <p class="card-text">{{ r.desc }}</p>
                <button class="btn btn-outline-primary explore-btn">
                  Kh√°m ph√° ngay
                </button>
              </div>
            </div>
          </div>

          {% endfor %}
        </div>
      </div>
    </section>

    <!-- Modal ƒëƒÉng k√Ω/ƒëƒÉng nh·∫≠p -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4 border-0">
          <!-- Header modal -->
          <div class="modal-header border-0 p-0 mb-3">
            <h5 id="modalTitle" class="modal-title">ƒêƒÉng nh·∫≠p</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <!-- Body modal -->
          <div class="modal-body">
            <!-- Form ƒêƒÉng nh·∫≠p -->
            <div id="loginForm">
              <div class="mb-3">
                <label for="loginEmail" class="form-label"
                  >Email ƒëƒÉng nh·∫≠p</label
                >
                <input
                  type="email"
                  class="form-control"
                  id="loginEmail"
                  name="email"
                  placeholder="Email"
                />
              </div>
              <div class="mb-3">
                <label for="loginPassword" class="form-label">M·∫≠t kh·∫©u</label>
                <input
                  type="password"
                  name="password"
                  id="loginPassword"
                  class="form-control"
                  placeholder="M·∫≠t kh·∫©u"
                />
              </div>
              <div class="mb-3 text-center fs-4">
                <span>B·∫°n ch∆∞a c√≥ t√†i kho·∫£n? </span>
                <a href="#" id="showRegisterLink">ƒêƒÉng k√Ω</a>
              </div>
              <button id="loginBtn" class="btn btn-primary w-100">
                ƒêƒÉng nh·∫≠p
              </button>
            </div>

            <!-- Form ƒêƒÉng k√Ω -->
            <div id="registerForm" class="d-none">
              <div class="mb-3">
                <label for="registerEmail" class="form-label"
                  >Email ƒëƒÉng k√Ω</label
                >
                <input
                  type="email"
                  name="email"
                  id="registerEmail"
                  class="form-control"
                  placeholder="Email"
                />
              </div>
              <div class="mb-3">
                <label for="registerPassword" class="form-label"
                  >M·∫≠t kh·∫©u</label
                >
                <input
                  type="password"
                  name="password"
                  id="registerPassword"
                  class="form-control"
                  placeholder="M·∫≠t kh·∫©u"
                />
              </div>
              <div class="mb-3">
                <label for="registerConfirmPassword" class="form-label"
                  >Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</label
                >
                <input
                  type="password"
                  name="confirm_password"
                  id="registerConfirmPassword"
                  class="form-control"
                  placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
                />
              </div>
              <div class="mb-3 text-center fs-4">
                <span>B·∫°n ƒë√£ c√≥ t√†i kho·∫£n? </span>
                <a href="#" id="showLoginLink">ƒêƒÉng nh·∫≠p</a>
              </div>
              <button id="registerBtn" class="btn btn-primary w-100">
                ƒêƒÉng k√Ω
              </button>
            </div>

            <!-- Form S·ªü th√≠ch / ƒê·ªãa ƒëi·ªÉm -->
            <div id="preferencesForm" class="d-none">
              <h5 class="mb-3 text-center">B·∫°n th√≠ch ƒëi du l·ªãch ·ªü ƒë√¢u?</h5>

              <!-- Lo·∫°i h√¨nh du l·ªãch -->
              <div class="mb-3">
                <label>Lo·∫°i h√¨nh du l·ªãch y√™u th√≠ch:</label>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    value="Bi·ªÉn"
                    id="prefSea"
                  />
                  <label class="form-check-label" for="prefSea">Bi·ªÉn</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    value="N√∫i"
                    id="prefMountain"
                  />
                  <label class="form-check-label" for="prefMountain">N√∫i</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    value="Th√†nh ph·ªë"
                    id="prefCity"
                  />
                  <label class="form-check-label" for="prefCity"
                    >Th√†nh ph·ªë</label
                  >
                </div>
              </div>

              <!-- ƒê·ªãa ƒëi·ªÉm c·ª• th·ªÉ -->
              <div class="mb-3">
                <label>ƒê·ªãa ƒëi·ªÉm b·∫°n quan t√¢m:</label>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    value="H√† N·ªôi"
                    id="locHN"
                  />
                  <label class="form-check-label" for="locHN">H√† N·ªôi</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    value="H·ªì Ch√≠ Minh"
                    id="locHCM"
                  />
                  <label class="form-check-label" for="locHCM"
                    >H·ªì Ch√≠ Minh</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    value="ƒê√† N·∫µng"
                    id="locDN"
                  />
                  <label class="form-check-label" for="locDN">ƒê√† N·∫µng</label>
                </div>
              </div>

              <button id="savePreferencesBtn" class="btn btn-success w-100">
                Ho√†n t·∫•t
              </button>
            </div>
          </div>
          <!-- modal-body -->
        </div>
      </div>
    </div>
  </body>

  <script>
    const searchInput = document.getElementById("searchInput");
    const suggestionsBox = document.getElementById("suggestions");

    let suggestionTimer;
    searchInput.addEventListener("input", function () {
      clearTimeout(suggestionTimer);
      const query = this.value.trim();
      suggestionsBox.innerHTML = "";

      if (query.length === 0) {
        suggestionsBox.style.display = "none";
        return;
      }

      // debounce 300ms
      suggestionTimer = setTimeout(async () => {
        try {
          // call FastAPI suggest endpoint (fallback local index)
          const res = await fetch(
            `http://127.0.0.1:8001/api/suggest?q=${encodeURIComponent(query)}`
          );
          if (!res.ok) {
            suggestionsBox.style.display = "none";
            return;
          }
          const data = await res.json();

          if (!Array.isArray(data) || data.length === 0) {
            suggestionsBox.style.display = "none";
            return;
          }

          data.forEach((item) => {
            const div = document.createElement("div");
            div.classList.add("suggestion-item");

            // accent-insensitive highlight: map normalized indices back to original
            function stripDiacritics(s) {
              return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }
            function highlightInsensitive(original, q) {
              if (!q) return original;
              const orig = original || "";
              const norm = stripDiacritics(orig).toLowerCase();
              const qnorm = stripDiacritics(q).toLowerCase();
              const idx = norm.indexOf(qnorm);
              if (idx === -1) return orig;
              // mapping normalized char index -> original index
              let mapping = [];
              let ni = 0;
              for (let oi = 0; oi < orig.length; oi++) {
                const ch = orig[oi];
                const chNorm = stripDiacritics(ch);
                for (let k = 0; k < chNorm.length; k++) {
                  mapping[ni++] = oi;
                }
              }
              const startOrig = mapping[idx];
              const endOrig = mapping[idx + qnorm.length - 1] + 1;
              const before = orig.slice(0, startOrig);
              const match = orig.slice(startOrig, endOrig);
              const after = orig.slice(endOrig);
              return `${before}<span class='highlight'>${match}</span>${after}`;
            }
            const highlighted = highlightInsensitive(item.name, query);

            const rating = item.rating || 0;
            div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><div>${highlighted}</div><div style="font-size:0.9rem;color:#6c757d">${
              rating ? rating.toFixed(1) + " ‚òÖ" : ""
            }</div></div>`;

            div.addEventListener("click", () => {
              searchInput.value = item.name;
              suggestionsBox.style.display = "none";
              // go to full search results page (Django) for compatibility
              window.location.href = `/search?q=${encodeURIComponent(
                item.name
              )}`;
            });
            suggestionsBox.appendChild(div);
          });

          suggestionsBox.style.display = "block";
        } catch (err) {
          console.error("Suggestion error", err);
        }
      }, 300);
    });

    document.addEventListener("click", (e) => {
      if (
        !searchInput.contains(e.target) &&
        !suggestionsBox.contains(e.target)
      ) {
        suggestionsBox.style.display = "none";
      }
    });

    // Pressing Enter in search input should go to search results
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const q = searchInput.value.trim();
        if (q) window.location.href = `/search?q=${encodeURIComponent(q)}`;
      }
    });

    // Search button click (smaller row) should also redirect
    const searchBtn = document.querySelector(".search-box .btn-warning");
    if (searchBtn) {
      searchBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const q = searchInput.value.trim();
        if (q) window.location.href = `/search?q=${encodeURIComponent(q)}`;
      });
    }
  </script>

  <script>
    // X·ª≠ l√Ω n√∫t "Kh√°m ph√° ngay"
    document.querySelectorAll(".btn-outline-primary").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const card = e.target.closest(".card");
        const title = card.querySelector(".card-title").textContent;
        const desc = card.querySelector(".card-text").textContent;
        const imgSrc = card.querySelector("img").src;

        // T·∫°o modal t·∫°m th·ªùi
        const modal = document.createElement("div");
        modal.classList.add("explore-modal");
        modal.innerHTML = `
    <div class="modal-content">
        <div class="close-icon"><i class="fa-solid fa-xmark"></i></div>
        <img src="${imgSrc}" alt="${title}">
        <h3>${title}</h3>
        <p>${desc}</p>
        <button class="close-btn">ƒê√≥ng</button>
    </div>
    `;

        document.body.appendChild(modal);

        // ƒê√≥ng modal
        modal.querySelector(".close-btn").addEventListener("click", () => {
          modal.remove();
        });
        modal.querySelector(".close-icon").addEventListener("click", () => {
          modal.remove();
        });
      });
    });
  </script>

  <script>
    // Khi r√™ chu·ªôt v√†o h√¨nh ‚Üí ch·∫°y slideshow
    document.querySelectorAll(".image-wrapper").forEach((wrapper) => {
      let slides = wrapper.querySelectorAll(".slide");
      let index = 0;
      let interval;

      function showSlide(n) {
        slides.forEach((s) => s.classList.remove("active"));
        slides[n].classList.add("active");
      }

      // B·∫Øt ƒë·∫ßu slideshow khi hover
      wrapper.addEventListener("mouseenter", () => {
        interval = setInterval(() => {
          index = (index + 1) % slides.length;
          showSlide(index);
        }, 2000);
      });

      // D·ª´ng slideshow khi r·ªùi chu·ªôt
      wrapper.addEventListener("mouseleave", () => {
        clearInterval(interval);
        index = 0;
        showSlide(index);
      });

      // ƒêi·ªÅu khi·ªÉn n√∫t tr√°i/ph·∫£i
      wrapper.querySelector(".prev").addEventListener("click", () => {
        index = (index - 1 + slides.length) % slides.length;
        showSlide(index);
      });

      wrapper.querySelector(".next").addEventListener("click", () => {
        index = (index + 1) % slides.length;
        showSlide(index);
      });
    });
  </script>

  <script>
    document.querySelectorAll(".image-wrapper").forEach((wrapper) => {
      const slides = wrapper.querySelectorAll(".slide");
      let index = 0;
      let interval;

      function showSlide(n) {
        slides.forEach((s) => s.classList.remove("active"));
        slides[n].classList.add("active");
      }

      wrapper.addEventListener("mouseenter", () => {
        interval = setInterval(() => {
          index = (index + 1) % slides.length;
          showSlide(index);
        }, 10000);
      });

      wrapper.addEventListener("mouseleave", () => {
        clearInterval(interval);
        index = 0;
        showSlide(index);
      });

      wrapper.querySelector(".prev").addEventListener("click", () => {
        index = (index - 1 + slides.length) % slides.length;
        showSlide(index);
      });

      wrapper.querySelector(".next").addEventListener("click", () => {
        index = (index + 1) % slides.length;
        showSlide(index);
      });
    });
  </script>

  <!-- Script chuy·ªÉn popup cho modal -->
  <script>
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const modalTitle = document.getElementById("modalTitle");
    const preferencesForm = document.getElementById("preferencesForm");

    document
      .getElementById("showRegisterLink")
      .addEventListener("click", (e) => {
        e.preventDefault();
        loginForm.classList.add("d-none");
        registerForm.classList.remove("d-none");
        modalTitle.textContent = "ƒêƒÉng k√Ω";
      });

    document.getElementById("showLoginLink").addEventListener("click", (e) => {
      e.preventDefault();
      registerForm.classList.add("d-none");
      loginForm.classList.remove("d-none");
      modalTitle.textContent = "ƒêƒÉng nh·∫≠p";
    });
  </script>

  <!-- X·ª≠ l√Ω ƒëƒÉng k√Ω ƒëƒÉng nh·∫≠p -->
  <script>
    // ƒêƒÉng nh·∫≠p
    document.getElementById("loginBtn").addEventListener("click", async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      try {
        const response = await fetch("/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const data = await response.json();

        if (response.ok) {
          // L∆∞u token
          localStorage.setItem("token", data.token);

          alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!");

          // Chuy·ªÉn trang
          window.location.href = "/"; // chuy·ªÉn v·ªÅ trang ch·ªß
        } else {
          alert(data.detail || data.error || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i");
        }
      } catch (err) {
        alert("L·ªói k·∫øt n·ªëi server: " + err);
      }
    });

    // ƒêƒÉng k√Ω
    document
      .getElementById("registerBtn")
      .addEventListener("click", async (e) => {
        e.preventDefault();
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        const confirmPassword = document.getElementById(
          "registerConfirmPassword"
        ).value;

        if (password !== confirmPassword) {
          alert("M·∫≠t kh·∫©u v√† x√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng tr√πng kh·ªõp!");
          return;
        }

        try {
          const response = await fetch("/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await response.json();

          if (response.ok) {
            alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");

            // 1. ·∫®n form ƒëƒÉng k√Ω
            document.getElementById("registerForm").classList.add("d-none");

            // 2. Hi·ªán form c√¢u h·ªèi
            document
              .getElementById("preferencesForm")
              .classList.remove("d-none");

            // 3. ƒê·ªïi ti√™u ƒë·ªÅ modal
            document.getElementById("modalTitle").textContent =
              "S·ªü th√≠ch du l·ªãch";
          } else {
            alert(JSON.stringify(data));
          }
        } catch (err) {
          alert("L·ªói k·∫øt n·ªëi server: " + err);
        }
      });
  </script>
</html>
